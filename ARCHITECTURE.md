# Architecture Overview

## System Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Load-Aware Batcher                        â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  1. Items Added (from multiple workers)             â”‚   â”‚
â”‚  â”‚     b.Add(ctx, item)                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                       â”‚                                      â”‚
â”‚                       â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  2. Internal Buffer (thread-safe)                   â”‚   â”‚
â”‚  â”‚     - Current capacity: currentBatchSize             â”‚   â”‚
â”‚  â”‚     - Mutex protected                                â”‚   â”‚
â”‚  â”‚     - Dynamic resizing                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                       â”‚                                      â”‚
â”‚                       â”‚ Flush Triggers:                      â”‚
â”‚                       â”‚ â€¢ Size: len(batch) >= currentSize    â”‚
â”‚                       â”‚ â€¢ Time: timeout expired              â”‚
â”‚                       â”‚ â€¢ Manual: Flush() called             â”‚
â”‚                       â”‚                                      â”‚
â”‚                       â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  3. Handler Function                                 â”‚   â”‚
â”‚  â”‚     HandlerFunc(ctx, batch)                          â”‚   â”‚
â”‚  â”‚     - Process batch (DB, API, etc.)                  â”‚   â”‚
â”‚  â”‚     - Measure metrics                                â”‚   â”‚
â”‚  â”‚     - Return LoadFeedback                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                       â”‚                                      â”‚
â”‚                       â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  4. Load Feedback Collection                         â”‚   â”‚
â”‚  â”‚     {                                                â”‚   â”‚
â”‚  â”‚       CPULoad: 0.75,                                 â”‚   â”‚
â”‚  â”‚       QueueDepth: 120,                               â”‚   â”‚
â”‚  â”‚       ProcessingTime: 150ms,                         â”‚   â”‚
â”‚  â”‚       ErrorRate: 0.05,                               â”‚   â”‚
â”‚  â”‚       DBLocks: 25                                    â”‚   â”‚
â”‚  â”‚     }                                                â”‚   â”‚
â”‚  â”‚     - Store in recentFeedback[]                      â”‚   â”‚
â”‚  â”‚     - Keep last 10 feedbacks                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                       â”‚                                      â”‚
â”‚                       â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  5. Load Score Calculation                           â”‚   â”‚
â”‚  â”‚     score = (CPU Ã— 0.4) + (Queue Ã— 0.2) +            â”‚   â”‚
â”‚  â”‚             (Errors Ã— 0.3) + (Locks Ã— 0.1)           â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚     avgScore = average(recent 10 scores)             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                       â”‚                                      â”‚
â”‚                       â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  6. Batch Size Adjustment (every LoadCheckInterval) â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚     if avgScore < 0.3:  ğŸŸ¢ LOW LOAD                  â”‚   â”‚
â”‚  â”‚         newSize = current + (current Ã— factor)       â”‚   â”‚
â”‚  â”‚         "Backend idle, increase batch size"          â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚     elif avgScore > 0.7:  ğŸ”´ HIGH LOAD               â”‚   â”‚
â”‚  â”‚         newSize = current - (current Ã— factor)       â”‚   â”‚
â”‚  â”‚         "Backend stressed, decrease batch size"      â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚     else:  ğŸŸ¡ MEDIUM LOAD                            â”‚   â”‚
â”‚  â”‚         newSize = current                            â”‚   â”‚
â”‚  â”‚         "Backend stable, maintain size"              â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚     Clamp: min(max(newSize, MinSize), MaxSize)       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Adaptive Loop

```
Time: 0s  â†’ currentBatchSize = 20 (initial)
          â†“
Time: 1s  â†’ Process batch of 20
          â†’ LoadScore = 0.25 (low)
          â†“
Time: 3s  â†’ Adjustment triggered
          â†’ currentBatchSize = 20 + (20 Ã— 0.3) = 26 âœ“
          â†“
Time: 4s  â†’ Process batch of 26
          â†’ LoadScore = 0.22 (low)
          â†“
Time: 6s  â†’ Adjustment triggered
          â†’ currentBatchSize = 26 + (26 Ã— 0.3) = 34 âœ“
          â†“
Time: 7s  â†’ Process batch of 34
          â†’ LoadScore = 0.85 (high!) ğŸ”´
          â†“
Time: 9s  â†’ Adjustment triggered
          â†’ currentBatchSize = 34 - (34 Ã— 0.3) = 24 âœ“
          â†“
Time: 10s â†’ Process batch of 24
          â†’ LoadScore = 0.78 (high) ğŸ”´
          â†“
Time: 12s â†’ Adjustment triggered
          â†’ currentBatchSize = 24 - (24 Ã— 0.3) = 17 âœ“
          â†“
...continues adapting...
```

## Load Score Weights

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Metric         â”‚ Weight â”‚ Rationale          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ CPU Load       â”‚  40%   â”‚ Primary indicator  â”‚
â”‚ Error Rate     â”‚  30%   â”‚ Quality signal     â”‚
â”‚ Queue Depth    â”‚  20%   â”‚ Backlog indicator  â”‚
â”‚ DB Locks       â”‚  10%   â”‚ Contention signal  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Comparison: Fixed vs Adaptive

### Scenario: Load Spike at t=30s

```
Fixed Batch (size=50):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 Throughput: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆ
 Errors:     â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘
 Batch Size: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (constant 50)
             0s        15s       30s       45s   60s
                                â†‘
                          Load spike!
                          Many errors,
                          system overwhelmed


Load-Aware Batch:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 Throughput: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
 Errors:     â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ (minimal!)
 Batch Size: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚       â””â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€ (adapts)
             0s        15s       30s    â”‚   45s   60s
                                â†‘       â”‚
                          Load spike!   â”‚
                          Batch size    â”‚
                          reduces â†’ prevents errors
```

## Worker Pool Integration

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Worker 1 â”‚  â”‚Worker 2 â”‚  â”‚Worker 3 â”‚  â”‚Worker 4 â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚            â”‚            â”‚            â”‚
     â”‚ Add()      â”‚ Add()      â”‚ Add()      â”‚ Add()
     â”‚            â”‚            â”‚            â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Batcher      â”‚
          â”‚  (mutex lock) â”‚  â† Thread-safe
          â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ When size/timeout reached
                  â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Backend      â”‚
          â”‚  Processing   â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ Returns LoadFeedback
                  â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Adjust Size  â”‚  â† Adaptive!
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Real-World Example: Database Inserts

```
Without Load-Aware Batcher:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
10:00:00  Insert 100 records â†’ OK (1.2s)
10:00:02  Insert 100 records â†’ OK (1.3s)
10:00:04  Insert 100 records â†’ OK (1.2s)
10:00:06  [LOAD SPIKE] Other process starts
10:00:08  Insert 100 records â†’ SLOW (4.5s) 
10:00:13  Insert 100 records â†’ ERRORS (timeout)
10:00:18  Insert 100 records â†’ ERRORS (deadlock)
          âŒ System degraded


With Load-Aware Batcher:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
10:00:00  Insert 100 records â†’ OK (1.2s, score=0.25)
10:00:02  Insert 130 records â†’ OK (1.4s, score=0.22) â†‘ increased
10:00:04  Insert 160 records â†’ OK (1.5s, score=0.28) â†‘ increased
10:00:06  [LOAD SPIKE] Other process starts
10:00:08  Insert 160 records â†’ SLOW (3.8s, score=0.82) ğŸ”´
10:00:12  Insert 110 records â†’ OK (2.1s, score=0.68) â†“ reduced
10:00:14  Insert  80 records â†’ OK (1.5s, score=0.45) â†“ reduced
10:00:16  Insert  80 records â†’ OK (1.4s, score=0.42) â†’ stable
          âœ… System adapted, no errors!
```

## Key Benefits

1. **Self-Tuning**: No manual adjustment needed
2. **Prevents Overload**: Automatically backs off under pressure
3. **Maximizes Throughput**: Scales up when backend can handle it
4. **Error Reduction**: Fewer timeouts and failures
5. **Production-Ready**: Thread-safe, tested, documented
